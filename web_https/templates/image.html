{% include 'includes/header.html' %}
<title>Image debuging</title>

<header>
    <h1>List of all Tanks</h1>
</header>

<div style="display: flex;">
    <!-- Barre latérale -->
    <aside style="width: 200px; padding: 10px; border-right: 1px solid #ddd;">
        <nav>
            <ul style="list-style-type: none; padding: 0;">
                <input type="text" id="searchInput" placeholder="Search tanks..." onkeyup="filterTanks()" style="margin-top: 20px; padding: 10px; width: 100%; box-sizing: border-box;">
                {% for nation in nation_order %}
                    {% if tanks_by_nation[nation] %}
                        <li style="margin-bottom: 10px;">
                            <a href="#{{ nation }}" style="text-decoration: none;">{{ nation }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ul>
        </nav>
    </aside>

    <!-- Contenu principal -->
    <main style="flex-grow: 1; padding: 10px;">     
        {% for nation in nation_order %}
            {% if tanks_by_nation[nation] %}
            <h2 id="{{ nation }}" class="text-center">{{ nation }}</h2>
            <table class="justify-content-center" border="1" id="tankTable-{{ nation }}">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Image</th>
                        <th>MOE 1</th>
                        <th>MOE 2</th>
                        <th>MOE 3</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tank in tanks_by_nation[nation] %}
                    <tr class="tank-row">
                        <td>
                            <a href="{{ url_for('show_tank', tank_id=tank.id) }}">{{ tank.name }}</a>
                        </td>

                        <td>
                                <img src="{{ tank.api_image }}" 
                                    alt="ERROR"
                                    data-tank="{{ tank.name}}"
                                    data-type="image"
                                    onerror="flagError(this)">
                        </td>
                        
                        <td>
                            {% if tank.tier > 4 and tank.moe > 0 %}
                                {% set sanitized_name = tank.name | replace('/', '_') | replace('*', '_') | replace(':', '_') | replace('<', '_') | replace('>', '_') | replace('"', '_') | replace('|', '_') | replace('?', '_') | replace('\\', '_') %}
                                {% if tank.name == 'Chi-Ha' and tank.nation == 'China' %}
                                    {% set tank_image_path = 'images/tank/Chi_Ha.png' %}
                                {% elif tank.name == 'IS-2' and tank.nation == 'China' %}
                                    {% set tank_image_path = 'images/tank/IS_2.png' %}
                                {% endif %}

                                {% set moe_path = 'images/moe/tier ' ~ tank.tier ~ '/' ~ sanitized_name ~ ' moe n°1.jpg' %}
                                <img src="{{ url_for('static', filename=moe_path) }}"
                                 alt="ERROR"
                                data-tank="{{ tank.name }}"
                                data-type="moe1"
                                onerror="flagError(this)">
                            {% endif %}
                        </td>

                        <td>
                            {% if tank.tier > 4 and tank.moe > 1 %}
                                {% set moe_path = 'images/moe/tier ' ~ tank.tier ~ '/' ~ sanitized_name ~ ' moe n°2.jpg' %}
                                <img src="{{ url_for('static', filename=moe_path) }}"
                                 alt="ERROR"
                                data-tank="{{ tank.name }}"
                                data-type="moe2"
                                onerror="flagError(this)">
                            {% endif %}
                        </td>

                        <td>
                            {% if tank.tier > 4 and tank.moe > 2 %}
                                {% set moe_path = 'images/moe/tier ' ~ tank.tier ~ '/' ~ sanitized_name ~ ' moe n°3.jpg' %}
                                <img src="{{ url_for('static', filename=moe_path) }}"
                                 alt="ERROR"
                                data-tank="{{ tank.name }}"
                                data-type="moe3"
                                onerror="flagError(this)">
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% endif %}
        {% endfor %}
        <br>
    </main>
</div>

<script>
    const ignoredImages = {};

    fetch("/static/config/ignored_images.json")
        .then(res => res.json())
        .then(data => {
            Object.assign(ignoredImages, data);
            recheckImageErrors();
        });

    function updateTablesVisibility() {
        document.querySelectorAll("table").forEach(table => {
            const hasVisibleRow = [...table.querySelectorAll("tbody tr")]
                .some(r => r.style.display !== "none");

            let header = table.previousElementSibling;
            while (header && header.tagName.toLowerCase() !== "h2") {
                header = header.previousElementSibling;
            }

            table.style.display = hasVisibleRow ? "" : "none";
            if (header) header.style.display = hasVisibleRow ? "" : "none";
        });
    }

    function fuzzyMatch(str, pattern) {
        let s = str.replace(/\s+/g, '').toLowerCase();
        let p = pattern.replace(/\s+/g, '').toLowerCase();
        let i = 0;

        for (let c of s) {
            if (c === p[i]) i++;
            if (i === p.length) return true;
        }
        return false;
    }

    function flagError(img) {
        const row = img.closest("tr");
        const tank = img.dataset.tank;
        const type = img.dataset.type;

        if (ignoredImages[tank]?.includes(type)) return;

        img.classList.add("img-error");
        row.classList.add("errorRow");
        filterErrorRows();
    }

    function recheckImageErrors() {
        document.querySelectorAll("img.img-error").forEach(img => {
            const row = img.closest("tr");
            const tank = img.dataset.tank;
            const type = img.dataset.type;

            if (ignoredImages[tank]?.includes(type)) {
                img.classList.remove("img-error");

                if (![...row.querySelectorAll("img.img-error")].length) {
                    row.classList.remove("errorRow");
                    row.style.display = "none";
                }
            }
        });

        updateTablesVisibility();
    }

    function filterErrorRows() {
        document.querySelectorAll(".tank-row").forEach(row => {
            row.style.display = row.classList.contains("errorRow") ? "" : "none";
        });

        updateTablesVisibility();
    }

    function filterTanks() {
        const input = document.getElementById("searchInput").value;

        document.querySelectorAll(".tank-row").forEach(row => {
            if (!row.classList.contains("errorRow")) {
                row.style.display = "none";
                return;
            }

            const name = row.querySelector("td").innerText;
            row.style.display = fuzzyMatch(name, input) ? "" : "none";
        });

        updateTablesVisibility();
    }
</script>

{% include 'includes/footer.html' %}
